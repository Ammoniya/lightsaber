<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://cdn.jsdelivr.net/npm/p5@1.4.0/lib/p5.js"></script>
  <script src="https://docs.opencv.org/3.4.1/opencv.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
    var canvasElement;
    var canvasCtx;
    let beam;
    var detected=false;
    var prevRatio=0;
    let rotatedEllipse;
    var ratio;
    var angle;
    function setup() {}
    function draw() {
      clear();
      background(255,255,255,0);
      if(detected){   
        ratio =ratio*(rotatedEllipse.size.width*2.0/76.0);
        ratio=0.3*ratio+0.7*prevRatio;
        prevRatio=ratio;
        push();
        translate(rotatedEllipse.center.x, rotatedEllipse.center.y);
        rotate(angle*PI /180.0);
        scale(ratio, ratio);
        translate(-beam.width/2.0,0);
        image(beam,0,0);
        pop();
      }
    }
    
    window.onload = function() {
      var videoElement = document.getElementById('input_video');
      canvasElement = document.getElementById('output_canvas');
      canvasCtx = canvasElement.getContext('2d');
      beam = loadImage('./saber.png');
      const hands = new Hands({locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
      }});
      
      hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5,
        useCpuInference: false, //if m1 mac: true, else: false
        selfieMode:true
      });
      hands.onResults(onResults);
      const camera = new Camera(videoElement, {
        onFrame: async () => {
          await hands.send({image: videoElement});
        },
        width: 1280,
        height: 720
      });
      camera.start();
    };
    
    function cvFunction(landmarks,width,height){      
      let points1 = [];
      for(var i=2;i<21;i++){
        points1.push(landmarks[i].x*width);
        points1.push(landmarks[i].y*height);
      }         
      let mat = cv.matFromArray(points1.length/2, 1, cv.CV_32SC2, points1);      
      rotatedEllipse = cv.fitEllipse(mat);
      mat.delete();
    }
   
    function calcHandState(landmarks,width,height){
      var dx=(landmarks[7].x-landmarks[4].x)*width;
      var dy=(landmarks[7].y-landmarks[4].y)*height;
      var distance1 = Math.sqrt(dx*dx + dy*dy);
      dx=(landmarks[7].x-landmarks[19].x)*width;
      dy=(landmarks[7].y-landmarks[19].y)*height;
      var distance2 = Math.sqrt(dx*dx + dy*dy);
      ratio=distance1/distance2;
      //1.3:sumb up 0.6:close
      ratio=map(ratio,0.95,1.3,0,1,true);
           
      angle = rotatedEllipse.angle;
      if(angle<90){
        angle=angle-180;
      }
    }
    
    function onResults(results) {     
      var width=results.image.width;
      var height=results.image.height;
      if(width!=canvasElement.width){
        //入力画像と同じサイズのcanvasを用意
        canvasElement.width=width;
        canvasElement.height=height;
        createCanvas(width, height);
      }
      detected=false;
      canvasCtx.save();
      //canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
      canvasCtx.drawImage(results.image, 0, 0, width, height);      
      if (results.multiHandLandmarks) {        
        for (const landmarks of results.multiHandLandmarks) {   
          drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS,{color: '#00FF00', lineWidth: 2});
          drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 1,radius:2});  
          cvFunction(landmarks,width,height);  
          calcHandState(landmarks,width,height);
          detected=true;
        }
      }
      canvasCtx.restore();  
    }
  </script>
</head>

<body>
    <video id="input_video" style="position:absolute; display:none;"></video>
    <canvas id="output_canvas" style="position:absolute;"></canvas>
    <main style="position:absolute;"></main>
</body>
</html>
